#!/usr/bin/env python3
import argparse
import requests
import tempfile
import os
from collections import Counter
from mkp import Package

API_BASE = "https://exchange.checkmk.com"


# Fetch package metadata from the correct API structure
def fetch_packages_metadata(n):
    url = f"{API_BASE}/api/package/search"
    per_page = 10  # as seen in API response
    pages = (n + per_page - 1) // per_page
    packages = []
    for page in range(1, pages + 1):
        params = {
            "sort": "date",
            "direction": "desc",
            "page": page,
            "search": ""
        }
        resp = requests.get(url, params=params)
        resp.raise_for_status()
        data = resp.json()
        page_packages = data.get("data", {}).get("packages", {}).get("data", [])
        packages.extend(page_packages)
        if len(packages) >= n:
            break
    return packages[:n]


# Download MKP file from full URL
def download_package(url):
    if url.startswith("/"):
        url = API_BASE + url
    resp = requests.get(url, stream=True)
    resp.raise_for_status()
    tmp = tempfile.NamedTemporaryFile(delete=False)
    for chunk in resp.iter_content(chunk_size=8192):
        tmp.write(chunk)
    tmp.close()
    return tmp.name


# Main CLI logic
def main():
    parser = argparse.ArgumentParser(
        description="Crawl Checkmk Exchange and count top-level directories in MKP packages.")
    parser.add_argument("-n", type=int, default=20, help="Number of packages to process (default: 20)")
    args = parser.parse_args()

    print(f"Fetching metadata for {args.n} packages...")
    packages = fetch_packages_metadata(args.n)
    counter = Counter()
    total = 0
    for pkg in packages:
        # Get download URL from latest version
        versions = pkg.get("versions", {})
        latest = versions.get("latest", {})
        download_url = latest.get("download_url")
        if not download_url:
            print(f'No download URL found for package {pkg.get("name")}, skipping.')
            continue
        path = None  # Ensure path is always defined
        try:
            path = download_package(download_url)
            with open(path, "rb") as f:
                package = Package(f)
                dirs = package.info.get("files", {}).keys()
                counter.update(dirs)
                total += 1
        except Exception as e:
            print(f"Error processing package: {e}")
        finally:
            if path and os.path.exists(path):
                os.remove(path)
    print(f"\nProcessed {total} packages.")
    print("Top-level directory counts:")
    for key, count in counter.most_common():
        print(f"  {key}: {count}")


if __name__ == "__main__":
    main()
